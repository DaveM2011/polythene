{"version":3,"sources":["../../src/src/menu/menu.js"],"names":["CSS_CLASSES","block","content","placeholder","visible","permanent","target","width_n","width_auto","listTile","selectedListTile","OFFSET_V","DEFAULT_OFFSET_H","MIN_SIZE","positionMenu","ctrl","opts","targetEl","document","querySelector","offsetH","offset","undefined","menuEl","el","contentEl","origin","reposition","positionOffset","firstItem","querySelectorAll","selectedItem","firstItemRect","getBoundingClientRect","selectedItemRect","top","alignEl","alignRect","targetRect","heightDiff","height","parentRect","parentNode","alignLeft","style","left","alignRight","right","alignTop","alignBottom","bottom","alignFn","call","show","isTransitioning","showClass","then","didShow","id","hide","didHide","redraw","unifySize","size","widthClass","sizeStr","toString","replace","createView","listenEl","body","activateDismissTap","addEventListener","handleDismissTap","deActivateDismissTap","removeEventListener","e","defaultPrevented","hideDelay","tag","props","class","join","config","inited","context","vdom","update","handleEscape","which","subscribe","setTimeout","onunload","unsubscribe","onclick","preventDefault","z","animated","before","after","component","controller","view"],"mappings":"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","file":"menu.js","sourcesContent":["import events from '../common/events';\nimport m from 'mithril';\nimport shadow from '../shadow/shadow';\nimport transition from '../common/transition';\nimport './theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-menu',\n    content: 'pe-menu__content',\n    placeholder: 'pe-menu--placeholder',\n    visible: 'pe-menu--visible',\n    permanent: 'pe-menu--permanent',\n    target: 'pe-menu--target',\n    width_n: 'pe-menu--width-',\n    width_auto: 'pe-menu--width-auto',\n\n    // lookup\n    listTile: 'pe-list-tile',\n    selectedListTile: 'pe-list-tile--selected'\n};\n\nconst OFFSET_V = -8;\nconst DEFAULT_OFFSET_H = 16;\nconst MIN_SIZE = 1.5;\n\nconst positionMenu = (ctrl, opts) => {\n    if (!opts.target) {\n        return;\n    }\n    const targetEl = document.querySelector('#' + opts.target);\n    if (!targetEl) {\n        return;\n    }\n    const offsetH = (opts.offset !== undefined) ? opts.offset : DEFAULT_OFFSET_H;\n    const menuEl = ctrl.el;\n    if (!menuEl) {\n        return;\n    }\n    const contentEl = ctrl.contentEl;\n    const origin = opts.origin || 'top-left';\n    const reposition = opts.reposition === false ? false : true;\n    let positionOffset = 0;\n    if (reposition) {\n        const firstItem = contentEl.querySelectorAll('.' + CSS_CLASSES.listTile)[0];\n        const selectedItem = contentEl.querySelector('.' + CSS_CLASSES.selectedListTile);\n        if (firstItem && selectedItem) {\n            // calculate v position: menu should shift upward relative to the first item\n            const firstItemRect = firstItem.getBoundingClientRect();\n            const selectedItemRect = selectedItem.getBoundingClientRect();\n            positionOffset = selectedItemRect.top - firstItemRect.top;\n        }\n        // align to middle of target\n        const alignEl = selectedItem || firstItem;\n        const alignRect = alignEl.getBoundingClientRect();\n        const targetRect = targetEl.getBoundingClientRect();\n        const heightDiff = alignRect.height - targetRect.height;\n        positionOffset += heightDiff / 2;\n\n    }\n    const targetRect = targetEl.getBoundingClientRect();\n    const parentRect = menuEl.parentNode.getBoundingClientRect();\n    const alignLeft = () => (menuEl.style.left = targetRect.left - parentRect.left + offsetH + 'px');\n    const alignRight = () => (menuEl.style.right = targetRect.right - parentRect.right + offsetH + 'px');\n    const alignTop = () => (menuEl.style.top = targetRect.top - parentRect.top - positionOffset + OFFSET_V + 'px');\n    const alignBottom = () => (menuEl.style.bottom = targetRect.bottom - parentRect.bottom - positionOffset + 'px');\n    const alignFn = {\n        'top-left': () => (alignTop() && alignLeft()),\n        'top-right': () => (alignTop() && alignRight()),\n        'bottom-left': () => (alignBottom() && alignLeft()),\n        'bottom-right': () => (alignBottom() && alignRight())\n    };\n    alignFn[origin].call();\n};\n\nconst show = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        if (opts.didShow) {\n            opts.didShow(opts.id);\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        if (opts.didHide) {\n            opts.didHide(opts.id);\n        }\n        m.redraw(); // removes remainder of drawn component\n    });\n};\n\nconst unifySize = (size) => {\n    return (size < MIN_SIZE) ? MIN_SIZE : size;\n};\n\nconst widthClass = (size) => {\n    const sizeStr = size.toString().replace('.', '-');\n    return CSS_CLASSES.width_n + sizeStr;\n};\n\nconst createView = (ctrl, opts = {}) => {\n    const listenEl = document.body;\n    const activateDismissTap = () => {\n        listenEl.addEventListener('click', handleDismissTap);\n    };\n    const deActivateDismissTap = () => {\n        listenEl.removeEventListener('click', handleDismissTap);\n    };\n    const handleDismissTap = (e) => {\n        if (e.target === ctrl.el) {\n            return;\n        }\n        deActivateDismissTap();\n        if (e.defaultPrevented) {\n            // clicked on .pe-menu__content\n            hide(ctrl, opts);\n        } else {\n            hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n        }\n    };\n    const tag = opts.tag || 'div';\n    const props = {\n        class: [\n            CSS_CLASSES.block,\n            opts.permanent ? CSS_CLASSES.permanent : null,\n            opts.target ? CSS_CLASSES.target : 'layout center-center',\n            opts.size ? widthClass(unifySize(opts.size)) : null,\n            opts.class\n        ].join(' '),\n\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const update = () => {\n                positionMenu(ctrl, opts);\n                m.redraw();\n            };\n\n            const handleEscape = (e) => {\n                if (e.which === 27) {\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            if (!opts.permanent) {\n                events.subscribe('resize', update);\n                events.subscribe('keydown', handleEscape);\n                setTimeout(() => {\n                    activateDismissTap();\n                    show(ctrl, opts);\n                }, 0);\n            }\n            context.onunload = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n                if (!opts.permanent) {\n                    deActivateDismissTap();\n                }\n            };\n\n            positionMenu(ctrl, opts);\n        }\n    };\n    const content = m('div', {\n        class: CSS_CLASSES.content,\n        config: (el, inited) => {\n            if (!inited) {\n                ctrl.contentEl = el;\n            }\n        },\n        onclick: (e) => {\n            e.preventDefault();\n        }\n    }, [\n        m(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.content ? opts.content : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (opts = {}) => {\n        let z = (opts.z !== undefined) ? opts.z : 1;\n        return {\n            z: z,\n            el: null,\n            contentEl: null,\n            isTransitioning: false,\n            visible: opts.permanent || false\n        };\n    },\n    view: (ctrl, opts = {}) => {\n        if (opts.show && !ctrl.visible) {\n            ctrl.visible = true;\n        }\n        if (ctrl.visible) {\n            return createView(ctrl, opts);\n        } else {\n            return m('span', {class: CSS_CLASSES.placeholder});\n        }\n    }\n};\n\nexport default component;\n"]}